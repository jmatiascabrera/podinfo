name: "Main pipeline"

on:
  workflow_dispatch:
    inputs:
      image_tag:
        required: true
        description: "Container image tag to promote"
      image_repository:
        required: false
        description: "Full image repository (without tag)"
        default: "745892955196.dkr.ecr.us-east-1.amazonaws.com/javier/podinfo"
#  push:
#    paths-ignore:
#      - "**/.argocd-source-*"
#    #      - ".github/workflows/**"
#    #      - ".github/actions/**"
#    branches:
#      - main
#    tags:
#      - 'v*'
jobs:

  unit_tests:
    name: "Run unit tests"
    runs-on: self-hosted-runner-docker

    steps:
      - uses: actions/checkout@v4
        name: Checkout code


  code_scan_security:
    name: "Run code security scan"
    runs-on: self-hosted-runner-docker
    steps:

      - uses: actions/checkout@v4
        name: Checkout code

      - uses: ./.github/actions/run-scan-security
        name: "Run code security scan"
        with:
          wait: 8

  code_lint:
    name: "Run code linters"
    runs-on: self-hosted-runner-docker
    steps:

      - uses: actions/checkout@v4
        name: Checkout code

      - uses: ./.github/actions/run-linters
        name: "Run code linters"
        with:
          wait: 2

  code_scan_quality:
    name: "Run code quality scan"
    runs-on: self-hosted-runner-docker
    needs: [ unit_tests ]
    steps:

      - uses: actions/checkout@v4
        name: Checkout code

      - uses: ./.github/actions/run-scan-quality
        name: "Run code quality scan"
        with:
          wait: 2



  deploy_dev:
    name: "Deploy to DEV"
    runs-on: self-hosted-runner-docker
    environment: dev
    needs: [ code_scan_quality, code_scan_security, code_lint ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote dev image
        uses: ./.github/actions/promote-environment
        with:
          environment: dev
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository }}


  end-to-end-tests:
    name: "End-to-End Tests with Kind and Kustomize"
    runs-on: ubuntu-latest
    needs: [ deploy_dev ]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Disk Cleanup
        uses: ./.github/actions/runner-cleanup
      - name: Setup Kubernetes
        uses: helm/kind-action@v1.13.0
        with:
          cluster_name: kind
      - name: Build container image
        run: |
          ./test/build.sh
          kind load docker-image test/podinfo:latest
      - name: Deploy
        run: ./test/deploy.sh
      - name: Run integration tests
        run: ./test/test.sh
      - name: Debug failure
        if: failure()
        run: |
          kubectl logs -l app=podinfo || true

  deploy_preq:
    name: "Deploy to PREQ"
    runs-on: self-hosted-runner-docker
    environment: preq
    needs: [ deploy_dev ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote preq image
        uses: ./.github/actions/promote-environment
        with:
          environment: preq
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository }}

  deploy_qa:
    name: "Deploy to QA"
    runs-on: self-hosted-runner-docker
    environment: qa
    needs: [ deploy_preq ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote qa image
        uses: ./.github/actions/promote-environment
        with:
          environment: qa
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository }}


  deploy_prod:
    name: "Deploy to PROD"
    runs-on: self-hosted-runner-docker
    environment: prod
    needs: [ deploy_qa ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote prod image
        uses: ./.github/actions/promote-environment
        with:
          environment: prod
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository }}
