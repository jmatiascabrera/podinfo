name: "Main pipeline"

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      image_tag:
        required: true
        description: "Container image tag to promote"
      image_repository:
        required: false
        description: "Full image repository (without tag)"
        default: ""
#  push:
#    paths-ignore:
#      - "**/.argocd-source-*"
#    #      - ".github/workflows/**"
#    #      - ".github/actions/**"
#    branches:
#      - main
#    tags:
#      - 'v*'


env:
  KUBERNETES_VERSION: 1.34.0
  IMAGE_REPOSITORY: 745892955196.dkr.ecr.us-east-1.amazonaws.com/javier/podinfo


jobs:

  unit_tests:
    name: "Run unit tests"
    runs-on: self-hosted-runner-docker-medium
    steps:

      - uses: actions/checkout@v6

      - uses: ./.github/actions/runner-cleanup

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25.x
          cache-dependency-path: |
            **/go.sum
            **/go.mod


      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v${{ env.KUBERNETES_VERSION }}

      - name: Setup kubeconform
        uses: ./.github/actions/kubeconform

      - name: Install make on Ubuntu/Debian
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends make

      - name: Run unit tests
        run: make test

      - name: Validate Kustomize overlay
        run: |
          kubectl kustomize ./kustomize/bases | kubeconform -strict -summary -kubernetes-version ${{ env.KUBERNETES_VERSION }}


  code_scan_security:
    name: "Run code security scan"
    runs-on: self-hosted-runner-docker-medium
    steps:

      - uses: actions/checkout@v6
        name: Checkout code

      - uses: ./.github/actions/run-scan-security
        name: "Run code security scan"
        with:
          wait: 8


  code_scan_quality:
    name: "Run code quality scan"
    runs-on: self-hosted-runner-docker-small
    steps:

      - uses: actions/checkout@v6
        name: Checkout code

      - uses: ./.github/actions/run-scan-quality
        name: "Run code quality scan"
        with:
          wait: 2



  deploy_dev:
    name: "Deploy to DEV"
    runs-on: self-hosted-runner-docker-small
    environment: dev
    needs: [ code_scan_quality, code_scan_security, unit_tests ]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote dev image
        uses: ./.github/actions/promote-environment
        with:
          environment: dev
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository || env.IMAGE_REPOSITORY }}


  end-to-end-tests:
    name: "End-to-End Tests"
    runs-on: self-hosted-runner-docker-medium
    needs: [ code_scan_quality, code_scan_security, unit_tests ]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      - name: Disk Cleanup
        uses: ./.github/actions/runner-cleanup
      - name: Setup Kubernetes
        uses: helm/kind-action@v1.13.0
        with:
          cluster_name: kind
      - name: Build container image
        run: |
          ./test/build.sh
          kind load docker-image test/podinfo:latest
      - name: Deploy
        run: ./test/deploy.sh
      - name: Run integration tests
        run: ./test/test.sh
      - name: Debug failure
        if: failure()
        run: |
          kubectl logs -l app=podinfo || true

  deploy_preq:
    name: "Deploy to PREQ"
    runs-on: self-hosted-runner-docker-small
    environment: preq
    needs: [ deploy_dev ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote preq image
        uses: ./.github/actions/promote-environment
        with:
          environment: preq
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository || env.IMAGE_REPOSITORY }}

  deploy_qa:
    name: "Deploy to QA"
    runs-on: self-hosted-runner-docker-small
    environment: qa
    needs: [ deploy_preq, end-to-end-tests ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote qa image
        uses: ./.github/actions/promote-environment
        with:
          environment: qa
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository || env.IMAGE_REPOSITORY }}


  deploy_prod:
    name: "Deploy to PROD"
    runs-on: self-hosted-runner-docker-small
    environment: prod
    needs: [ deploy_qa ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Promote prod image
        uses: ./.github/actions/promote-environment
        with:
          environment: prod
          image_tag: ${{ inputs.image_tag }}
          image_repository: ${{ inputs.image_repository || env.IMAGE_REPOSITORY }}
