name: "Main pipeline"

permissions:
  contents: write

on:
  push:
    tags:
      - 'v*'

env:
  KUBERNETES_VERSION: 1.34.2
  IMAGE_REPOSITORY: 745892955196.dkr.ecr.us-east-1.amazonaws.com/javier/podinfo


jobs:

  unit_tests:
    name: "Run unit tests"
    runs-on: self-hosted-runner-medium

    steps:

      - uses: actions/checkout@v6
        name: Checkout code

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.25.x
          cache-dependency-path: |
            **/go.sum
            **/go.mod

      - name: Run unit tests
        run: make test


  code_scan_security:
    name: "Run code security scan"
    runs-on: self-hosted-runner-small

    steps:

      - uses: actions/checkout@v6
        name: Checkout code

      - uses: ./.github/actions/run-scan-security
        name: "Run code security scan"
        with:
          wait: 8


  code_scan_quality:
    name: "Run code quality scan"
    runs-on: self-hosted-runner-small

    steps:
      - uses: actions/checkout@v6
        name: Checkout code

      - uses: ./.github/actions/run-scan-quality
        name: "Run code quality scan"
        with:
          wait: 2

  build-docker-image:
    name: "Build and push Docker image"
    runs-on: self-hosted-runner-large
    outputs:
      image_tag: ${{ steps.build.outputs.image_tag }}
      image_repository: ${{ steps.build.outputs.image_repository }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Build and publish images
        id: build
        uses: ./.github/actions/build-docker-image
        with:
          image_repository: ${{ env.IMAGE_REPOSITORY }}

  deploy_dev:
    name: "Deploy to DEV"
    runs-on: self-hosted-runner-small
    environment: dev
    needs: [ code_scan_quality, code_scan_security, unit_tests, build-docker-image ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Promote dev image
        uses: ./.github/actions/promote-environment
        with:
          environment: dev
          image_tag: ${{ needs.build-docker-image.outputs.image_tag }}
          image_repository: ${{ needs.build-docker-image.outputs.image_repository }}


  deploy_preq:
    name: "Deploy to PREQ"
    runs-on: self-hosted-runner-small
    environment: preq
    needs: [ deploy_dev, build-docker-image ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Promote preq image
        uses: ./.github/actions/promote-environment
        with:
          environment: preq
          image_tag: ${{ needs.build-docker-image.outputs.image_tag }}
          image_repository: ${{ needs.build-docker-image.outputs.image_repository }}

  deploy_qa:
    name: "Deploy to QA"
    runs-on: self-hosted-runner-small
    environment: qa
    needs: [ deploy_preq, build-docker-image ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Promote qa image
        uses: ./.github/actions/promote-environment
        with:
          environment: qa
          image_tag: ${{ needs.build-docker-image.outputs.image_tag }}
          image_repository: ${{ needs.build-docker-image.outputs.image_repository }}


  deploy_prod:
    name: "Deploy to PROD"
    runs-on: self-hosted-runner-small
    environment: prod
    needs: [ deploy_qa, build-docker-image ]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Promote prod image
        uses: ./.github/actions/promote-environment
        with:
          environment: prod
          image_tag: ${{ needs.build-docker-image.outputs.image_tag }}
          image_repository: ${{ needs.build-docker-image.outputs.image_repository }}
